<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xm</title>
    <style>
        body, html {
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            font-family: Arial, sans-serif;
            flex-direction: column;
        }

        #loading-bar-container {
            width: 300px;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #loading-bar {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.5s;
        }

        #message {
            text-align: center;
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        #debug {
            width: 80%;
            height: 200px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            margin-top: 20px;
            font-size: 14px;
        }

        #webgazerVideoContainer {
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
        }
    </style>
</head>
<body>
    <div id="loading-bar-container">
        <div id="loading-bar"></div>
    </div>
    <div id="message">Center your face in the camera for 1 minute</div>
    <div id="debug"></div>

    <script src="https://cdn.jsdelivr.net/npm/webgazer@3.3.0/dist/webgazer.min.js"></script>
    <script>
        let progress = 0;
        let meditationInterval;
        const loadingBar = document.getElementById("loading-bar");
        const messageElement = document.getElementById("message");
        const debugElement = document.getElementById("debug");
        const meditationDuration = 60; // 1 minute in seconds
        const checkInterval = 1000; // Check every 1 second
        let videoWidth = 320; // Default video width
        let videoHeight = 240; // Default video height

        const centeringHistory = [];
        const historyDuration = 3000; // 3 seconds of history
        const centeringThreshold = 0.9; // 90% threshold for considering uncentered

        function log(message) {
            console.log(message);
            debugElement.innerHTML += message + '<br>';
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        function updateProgress() {
            loadingBar.style.width = `${(progress / meditationDuration) * 100}%`;
            messageElement.textContent = `Centered focus maintained for ${progress} seconds`;

            if (progress >= meditationDuration) {
                finishSession();
            }
        }

        function resetProgress() {
            progress = 0;
            loadingBar.style.width = "0%";
            messageElement.textContent = "Center your face in the camera for 1 minute";
            log("Progress reset - Face not centered");
        }

        function finishSession() {
            clearInterval(meditationInterval);
            loadingBar.style.width = "100%";
            messageElement.textContent = "Great job! 1-minute meditation completed.";
            log("Meditation session completed!");
            webgazer.end();
        }

        function isFaceCentered(x, y) {
            const centerX = videoWidth / 2;
            const centerY = videoHeight / 2;
            const allowedDeviation = 0.25; // 25% deviation allowed

            const minX = centerX - (videoWidth * allowedDeviation);
            const maxX = centerX + (videoWidth * allowedDeviation);
            const minY = centerY - (videoHeight * allowedDeviation);
            const maxY = centerY + (videoHeight * allowedDeviation);

            return x >= minX && x <= maxX && y >= minY && y <= maxY;
        }

        function updateCenteringHistory(isCentered) {
            const now = Date.now();
            centeringHistory.push({ time: now, centered: isCentered });

            // Remove old entries
            while (centeringHistory.length > 0 && now - centeringHistory[0].time > historyDuration) {
                centeringHistory.shift();
            }
        }

        function isConsistentlyUncentered() {
            if (centeringHistory.length === 0) return false;

            const uncenterCount = centeringHistory.filter(entry => !entry.centered).length;
            return (uncenterCount / centeringHistory.length) > centeringThreshold;
        }

        function checkFaceDetection() {
            if (isConsistentlyUncentered()) {
                log("Face consistently not centered");
                resetProgress();
            } else {
                log("Face considered centered");
                progress += 1; // Increment by 1 second
                updateProgress();
            }
        }

        function startTracking() {
            log("Starting smoothed centered face detection...");
            meditationInterval = setInterval(checkFaceDetection, checkInterval);
        }

        webgazer.setGazeListener((data, elapsedTime) => {
            if (data !== null && data.x !== null && data.y !== null) {
                const centered = isFaceCentered(data.x, data.y);
                updateCenteringHistory(centered);
                log(`Face ${centered ? 'centered' : 'not centered'} at (${data.x.toFixed(2)}, ${data.y.toFixed(2)})`);
            }
        }).begin()
            .then(() => {
                log("WebGazer initialized successfully");
                webgazer.showVideo(true)
                       .showFaceOverlay(true)
                       .showFaceFeedbackBox(true);
                
                // Get actual video dimensions
                const videoElement = document.querySelector('#webgazerVideoContainer video');
                if (videoElement) {
                    videoWidth = videoElement.videoWidth;
                    videoHeight = videoElement.videoHeight;
                    log(`Video dimensions: ${videoWidth}x${videoHeight}`);
                }

                // Adjust video position
                const videoContainer = document.getElementById('webgazerVideoContainer');
                if (videoContainer) {
                    videoContainer.style.position = 'fixed';
                    videoContainer.style.top = '20px';
                    videoContainer.style.left = '20px';
                }

                startTracking();
            })
            .catch(error => {
                log(`Error initializing WebGazer: ${error}`);
            });

        // Error handling
        window.addEventListener('unhandledrejection', function(event) {
            log(`Unhandled promise rejection: ${event.reason}`);
        });

        window.onerror = function(message, source, lineno, colno, error) {
            log(`Error: ${message} at ${source}:${lineno}:${colno}`);
            return false;
        };
    </script>
</body>
</html>
